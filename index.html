<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriMaster Pro - Colección Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="data.js"></script>
</head>
<body class="bg-gray-50 text-slate-800 antialiased">

<div x-data="app()" x-init="initApp()" class="max-w-3xl mx-auto min-h-screen bg-white shadow-2xl flex flex-col border-x border-slate-200">
    
    <div class="bg-slate-900 text-white p-5 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-lg flex items-center justify-center text-xl font-bold">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="text-xl font-black tracking-tight">NUTRI<span class="text-emerald-400">MASTER</span></h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Base de Datos: 27 Planes</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-3xl font-black" x-text="Math.round(totals.kcal)">0</div>
                <div class="text-[10px] text-emerald-400 font-bold uppercase">Kcal <span x-text="currentDay"></span></div>
            </div>
        </div>

        <select x-model="selectedPlanIdx" @change="loadPlan" class="w-full bg-slate-800 border border-slate-700 text-white text-sm rounded-lg py-3 px-4 font-bold focus:ring-1 focus:ring-emerald-500 outline-none mb-3">
            <template x-for="(plan, idx) in plans" :key="idx">
                <option :value="idx" x-text="plan.nombre"></option>
            </template>
        </select>

        <div class="flex gap-1 overflow-x-auto pb-1 scrollbar-hide">
            <template x-for="day in weekDays" :key="day">
                <button @click="currentDay = day; loadPlan()" 
                        class="flex-1 py-2 px-2 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all border"
                        :class="currentDay === day ? 'bg-emerald-500 text-white border-emerald-500' : 'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700'">
                    <span x-text="day.substring(0,3)"></span>
                </button>
            </template>
        </div>
    </div>

    <div class="flex-1 p-4 overflow-y-auto">
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                <div class="text-blue-600 font-black text-xl" x-text="Math.round(totals.p)">0</div>
                <div class="text-[9px] text-slate-400 font-bold uppercase">Proteína</div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                <div class="text-amber-500 font-black text-xl" x-text="Math.round(totals.f)">0</div>
                <div class="text-[9px] text-slate-400 font-bold uppercase">Grasa</div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-100 text-center shadow-sm">
                <div class="text-rose-500 font-black text-xl" x-text="Math.round(totals.c)">0</div>
                <div class="text-[9px] text-slate-400 font-bold uppercase">Carbs</div>
            </div>
        </div>

        <div class="space-y-4 pb-20">
            <template x-for="meal in mealOrder" :key="meal">
                <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden" x-show="dayData[meal] && dayData[meal].length > 0">
                    <div class="px-4 py-2 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-black text-xs uppercase text-slate-700 tracking-widest" x-text="meal"></h3>
                        <span class="text-[9px] font-bold bg-white border border-slate-200 text-slate-500 px-2 py-0.5 rounded" 
                              x-text="getMealKcal(dayData[meal]) + ' kcal'"></span>
                    </div>
                    <ul class="divide-y divide-slate-50">
                        <template x-for="ing in dayData[meal]" :key="ing.n">
                            <li class="px-4 py-3 flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-sm text-slate-800" x-text="ing.n"></div>
                                    <div class="flex gap-2 text-[10px] text-slate-400 font-medium" x-show="db[ing.k]">
                                        <span x-text="'P: ' + Math.round(getMacros(ing).p)"></span>
                                        <span x-text="'G: ' + Math.round(getMacros(ing).f)"></span>
                                        <span x-text="'C: ' + Math.round(getMacros(ing).c)"></span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="font-black text-slate-900" x-text="ing.q"></div>
                                    <div class="text-[9px] font-bold text-slate-400 uppercase" x-text="getUnit(ing.k)"></div>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </template>
            <div x-show="!hasData" class="text-center py-12 text-slate-400 italic text-sm">
                Cargando datos del plan...
            </div>
        </div>
    </div>
</div>

<script>
function app() {
    return {
        // Vinculamos con el archivo externo data.js
        db: window.NUTRI_DB || {},
        plans: window.NUTRI_PLANS || [],
        weights: window.NUTRI_WEIGHTS || {},
        
        selectedPlanIdx: 0, // Por defecto el último (el más reciente)
        currentDay: 'Lunes',
        weekDays: ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'],
        // Normalizamos nombres para que siempre salgan en orden
        mealOrder: ['Desayuno', 'Media Mañana', 'Comida', 'Merienda', 'Cena'],
        dayData: {},
        totals: { p:0, f:0, c:0, kcal:0 },
        hasData: false,

        initApp() {
            // Seleccionar el último plan por defecto (suelen ser los más relevantes)
            if(this.plans.length > 0) {
                this.selectedPlanIdx = this.plans.length - 1;
            }
            this.loadPlan();
        },

        loadPlan() {
            const plan = this.plans[this.selectedPlanIdx];
            if (!plan) return;

            let rawDay = plan.dias[this.currentDay];
            // Si el día no existe, cogemos el Lunes para no mostrar vacío
            if (!rawDay) rawDay = plan.dias['Lunes'] || {};

            // Mapeo inteligente de nombres de comidas antiguos a los nuevos
            // (Ej: "Tentempié" -> "Media Mañana")
            this.dayData = {
                'Desayuno': rawDay['Desayuno'] || [],
                'Media Mañana': rawDay['Media Mañana'] || rawDay['Tentempié'] || rawDay['Tentempié 1'] || [],
                'Comida': rawDay['Comida'] || [],
                'Merienda': rawDay['Merienda'] || rawDay['Merienda 1'] || [],
                'Cena': rawDay['Cena'] || []
            };

            this.hasData = true;
            this.calcTotals();
        },

        getMacros(ing) {
            const item = this.db[ing.k];
            if (!item) return { p:0, f:0, c:0, k:0 };
            
            let amount = ing.q;
            // Si la cantidad es pequeña (<10) y es una unidad (ej. huevo), multiplicamos por peso estándar
            if (this.weights[ing.k] && ing.q < 10) {
                amount = ing.q * this.weights[ing.k];
            }

            return {
                p: (item.p * amount) / 100,
                f: (item.f * amount) / 100,
                c: (item.c * amount) / 100,
                k: (item.k * amount) / 100
            };
        },

        getMealKcal(ingredients) {
            if (!ingredients) return 0;
            return Math.round(ingredients.reduce((acc, curr) => acc + this.getMacros(curr).k, 0));
        },

        calcTotals() {
            this.totals = { p:0, f:0, c:0, kcal:0 };
            this.mealOrder.forEach(meal => {
                if (this.dayData[meal]) {
                    this.dayData[meal].forEach(ing => {
                        const m = this.getMacros(ing);
                        this.totals.p += m.p;
                        this.totals.f += m.f;
                        this.totals.c += m.c;
                        this.totals.kcal += m.k;
                    });
                }
            });
        },

        getUnit(k) {
            if(['leche','cafe'].includes(k)) return 'ml';
            if(this.weights[k]) return 'ud';
            return 'g';
        }
    }
}
</script>
</body>
</html>
